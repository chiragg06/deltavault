<template>
  <!-- ENTRY SCREEN -->
  <template if:true={isEntryStage}>
    <div class="entry-shell">
      <div class="entry-content">
        <div class="entry-icon">
          <template if:true={vaultIconUrl}>
            <img src={vaultIconUrl} alt="Vault Icon" onerror={handleIconError} />
          </template>
          <template if:false={vaultIconUrl}>
            <div class="fallback-icon">üîê</div>
          </template>
        </div>
        
        <h1 class="entry-title">DeltaVault</h1>
        <p class="entry-tagline">Track Every Change, Master Every Version</p>
        
        <button class="enter-vault-btn" onclick={enterVault}>
          <span class="door-icon">üö™</span>
          <span>Enter Vault</span>
        </button>
      </div>
    </div>
  </template>

  <!-- HOME SCREEN -->
  <template if:true={isHomeStage}>
    <div class="home-shell">
      <div class="home-header">
        <h1 class="home-title">DeltaVault</h1>
        <p class="home-subtitle">Select Component Type</p>
      </div>
      
      <div class="app-drawer">
        <button class="family-card omniprocess" data-family="OmniProcess" onclick={selectFamily}>
          <div class="card-icon">‚ö°</div>
          <h2 class="card-title">OmniProcess</h2>
          <p class="card-desc">OmniScripts & Integration Procedures</p>
        </button>
        
        <button class="family-card flexcard" data-family="Flexcard" onclick={selectFamily}>
          <div class="card-icon">üé¥</div>
          <h2 class="card-title">FlexCards</h2>
          <p class="card-desc">UI Cards & Components</p>
        </button>
        
        <button class="family-card dataraptor" data-family="DataMapper" onclick={selectFamily}>
          <div class="card-icon">üó∫Ô∏è</div>
          <h2 class="card-title">DataRaptors</h2>
          <p class="card-desc">Data Transformation & Mapping</p>
        </button>
      </div>
    </div>
  </template>

  <!-- VAULT SCREEN -->
  <template if:true={isVaultStage}>
    <div class="shell">
      <header class="topbar">
        <button class="back-btn" onclick={backToHome} title="Back to Home">‚óÄ</button>
        <div class="brand">DeltaVault</div>
        <div class="actions">
          <lightning-button variant="brand" label="Refresh" onclick={refresh}></lightning-button>
          <div class="chip">{statusText}</div>
        </div>
      </header>

      <div class="layout">
        <!-- Left Sidebar -->
        <aside class="sidebar" onscroll={handleListScroll}>
          <div class="sidebar-header">
            <div class="section-title">COMPONENTS ({family})</div>
            <lightning-input 
              type="search"
              variant="label-hidden"
              placeholder="Search..."
              value={search}
              onchange={onSearchChange}>
            </lightning-input>
          </div>
          
          <ul class="tree">
            <template for:each={uniqueComponents} for:item="comp">
              <li key={comp.baseName}
                  class="item"
                  data-basename={comp.baseName}
                  data-type={comp.type}
                  onclick={selectComponent}>
                <span class="file">üì¶</span>
                <div class="comp-info">
                  <strong>{comp.baseName}</strong>
                  <template if:true={comp.versionCount}>
                    <span class="ver-count">({comp.versionCount}v)</span>
                  </template>
                </div>
              </li>
            </template>
          </ul>
          
          <template if:true={listLoading}>
            <p class="muted loading-text">Loading...</p>
          </template>
        </aside>

        <!-- Right Panel -->
        <main class="main" onscroll={handleMainScroll}>
          <!-- Version Cards/List -->
          <template if:true={hasSelectedComponent}>
            <template if:false={selectedComponentId}>
              <div class="version-grid-container">
                <!-- Header with Title, Search, and View Toggle -->
                <div class="version-header">
                  <h2 class="main-title">{selectedComponentName}</h2>
                  
                  <div class="version-controls">
                    <!-- Search Input -->
                    <lightning-input 
                      type="search"
                      variant="label-hidden"
                      placeholder="Search versions..."
                      value={versionSearch}
                      onchange={onVersionSearchChange}
                      class="version-search">
                    </lightning-input>
                    
                    <!-- View Toggle Buttons -->
                    <div class="view-toggle">
                      <button 
                        class={gridViewBtnClass} 
                        onclick={switchToGridView}
                        title="Grid View">
                        <span class="icon">‚äû</span>
                      </button>
                      <button 
                        class={listViewBtnClass} 
                        onclick={switchToListView}
                        title="List View">
                        <span class="icon">‚ò∞</span>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- Grid View -->
                <template if:true={isGridView}>
                  <div class="version-grid">
                    <template for:each={filteredVersionCards} for:item="vc">
                      <button key={vc.componentId}
                              class="version-card"
                              data-componentid={vc.componentId}
                              data-version={vc.version}
                              onclick={selectVersion}>
                        <span class="version-icon">üì¶</span>
                        <span class="version-label">{vc.label}</span>
                        <template if:true={vc.latestAt}>
                          <span class="version-date">{vc.formattedDate}</span>
                        </template>
                      </button>
                    </template>
                  </div>
                </template>
                
                <!-- List View -->
                <template if:true={isListView}>
                  <div class="version-list">
                    <template for:each={filteredVersionCards} for:item="vc">
                      <button key={vc.componentId}
                              class="version-list-item"
                              data-componentid={vc.componentId}
                              data-version={vc.version}
                              onclick={selectVersion}>
                        <div class="version-list-left">
                          <span class="version-icon-small">üì¶</span>
                          <span class="version-label-large">{vc.label}</span>
                        </div>
                        <div class="version-list-right">
                          <template if:true={vc.latestAt}>
                            <span class="version-meta">{vc.formattedDate}</span>
                          </template>
                          <template if:true={vc.latestActor}>
                            <span class="version-actor">{vc.latestActor}</span>
                          </template>
                          <span class="version-arrow">‚Üí</span>
                        </div>
                      </button>
                    </template>
                  </div>
                </template>
                
                <!-- No Results Message -->
                <template if:true={showNoVersionResults}>
                  <div class="no-results">
                    <p class="muted">No versions match "{versionSearch}"</p>
                    <button class="text-btn" onclick={clearVersionSearch}>Clear Search</button>
                  </div>
                </template>
              </div>
            </template>
            
            <!-- History View -->
            <template if:true={selectedComponentId}>
              <!-- Tabs -->
              <div class="tabs">
                <button class={summaryTabClass} data-tab="summary" onclick={switchTab}>Summary</button>
                <button class={diffTabClass} data-tab="diff" onclick={switchTab}>Element Changes</button>
                <button class={timelineTabClass} data-tab="timeline" onclick={switchTab}>Timeline</button>
              </div>

              <!-- SUMMARY TAB -->
              <template if:true={showSummary}>
                <section class="tab-content">
                  <h1 class="title">{selectedComponentName} v{selectedVersion}</h1>
                  
                  <template for:each={historyItems} for:item="snap">
                    <article key={snap.id} class="history-card">
                      <div class="history-header">
                        <div class="history-badges">
                          <span class="badge change">{snap.changeType}</span>
                          <span class="badge version">v{snap.version}</span>
                          <template if:true={snap.actorName}>
                            <span class="badge actor">{snap.actorName}</span>
                          </template>
                        </div>
                        <span class="history-date">{snap.formattedDate}</span>
                      </div>
                      
                      <!-- AI-Generated Highlight Cards -->
                      <div class="notes-container" data-id={snap.id}></div>
                    </article>
                  </template>
                  
                  <template if:true={tlLoading}>
                    <p class="muted loading-text">Loading more...</p>
                  </template>
                </section>
              </template>

              <!-- DIFF TAB - SIMPLIFIED TWO-COLUMN TABLE -->
              <template if:true={showDiff}>
                <section class="tab-content">
                  <h1 class="title">{selectedComponentName} v{selectedVersion} - Element Changes</h1>
                  
                  <template for:each={historyItems} for:item="snap">
                    <article key={snap.id} class="history-card">
                      <div class="history-header">
                        <div class="history-badges">
                          <span class="badge change">{snap.changeType}</span>
                          <span class="badge version">v{snap.version}</span>
                        </div>
                        <span class="history-date">{snap.formattedDate}</span>
                      </div>
                      
                      <!-- TWO-COLUMN COMPARISON TABLE -->
                      <div class="comparison-container">
                        <div class="comparison-table-wrapper" data-comparison-table-id={snap.id}></div>
                      </div>
                      
                      <!-- Raw JSON Toggle -->
                      <div class="history-actions">
                        <button class="text-btn" data-id={snap.id} onclick={toggleRawJson}>
                          <template if:false={snap.showRawJson}>Show Raw JSON</template>
                          <template if:true={snap.showRawJson}>Hide Raw JSON</template>
                        </button>
                      </div>
                      
                      <template if:true={snap.showRawJson}>
                        <div class="details-section">
                          <h4>Raw JSON</h4>
                          <pre class="block">{snap.rawJson}</pre>
                        </div>
                      </template>
                    </article>
                  </template>
                </section>
              </template>

              <!-- TIMELINE TAB -->
              <template if:true={showTimeline}>
                <section class="tab-content">
                  <h1 class="title">{selectedComponentName} v{selectedVersion} - Timeline</h1>
                  
                  <ul class="timeline">
                    <template for:each={historyItems} for:item="snap">
                      <li key={snap.id}>
                        <span class="tl-ver">v{snap.version}</span>
                        <span class="tl-when">{snap.formattedDate}</span>
                        <template if:true={snap.actorName}>
                          ‚Äî <span class="tl-actor">{snap.actorName}</span>
                        </template>
                        <span class="tl-change">({snap.changeType})</span>
                      </li>
                    </template>
                  </ul>
                </section>
              </template>
            </template>
          </template>

          <!-- Empty state -->
          <template if:false={hasSelectedComponent}>
            <div class="empty-state">
              <p class="muted">Select a component from the left to view its version history</p>
            </div>
          </template>
        </main>
      </div>
    </div>
  </template>
</template>