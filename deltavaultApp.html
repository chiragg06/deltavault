<template>
  <!-- ======================== -->
  <!-- ENTRY SCREEN: ICON + ENTER VAULT -->
  <!-- ======================== -->
  <template if:true={isEntryStage}>
    <div class="entry-shell">
      <div class="entry-content">
        <!-- Vault Icon -->
        <div class="entry-icon">
          <template if:true={vaultIconUrl}>
            <img src={vaultIconUrl} alt="Vault Icon" onerror={handleIconError} />
          </template>
          <template if:false={vaultIconUrl}>
            <div class="fallback-icon">üîê</div>
          </template>
        </div>
        
        <h1 class="entry-title">DeltaVault</h1>
        <p class="entry-tagline">Track Every Change, Master Every Version</p>
        
        <button class="enter-vault-btn" onclick={enterVault}>
          <span class="door-icon">üö™</span>
          <span>Enter Vault</span>
        </button>
      </div>
    </div>
  </template>

  <!-- ======================== -->
  <!-- HOME SCREEN: APP DRAWER (3 BIG CARDS) -->
  <!-- ======================== -->
  <template if:true={isHomeStage}>
    <div class="home-shell">
      <div class="home-header">
        <h1 class="home-title">DeltaVault</h1>
        <p class="home-subtitle">Select Component Type</p>
      </div>
      
      <div class="app-drawer">
        <button class="family-card omniprocess" data-family="OmniProcess" onclick={selectFamily}>
          <div class="card-icon">‚ö°</div>
          <h2 class="card-title">OmniProcess</h2>
          <p class="card-desc">OmniScripts & Integration Procedures</p>
        </button>
        
        <button class="family-card flexcard" data-family="Flexcard" onclick={selectFamily}>
          <div class="card-icon">üé¥</div>
          <h2 class="card-title">FlexCards</h2>
          <p class="card-desc">UI Cards & Components</p>
        </button>
        
        <button class="family-card dataraptor" data-family="DataMapper" onclick={selectFamily}>
          <div class="card-icon">üó∫Ô∏è</div>
          <h2 class="card-title">DataRaptors</h2>
          <p class="card-desc">Data Transformation & Mapping</p>
        </button>
      </div>
    </div>
  </template>

  <!-- ======================== -->
  <!-- VAULT SCREEN: LOGBOOK UI -->
  <!-- ======================== -->
  <template if:true={isVaultStage}>
    <div class="shell">
      <!-- Top Bar -->
      <header class="topbar">
        <button class="back-btn" onclick={backToHome} title="Back to Home">
          ‚óÄ
        </button>
        <div class="brand">DeltaVault</div>
        <div class="actions">
          <lightning-button variant="brand" label="Refresh" onclick={refresh}></lightning-button>
          <div class="chip">{statusText}</div>
        </div>
      </header>

      <!-- Main Layout -->
      <div class="layout">
        <!-- Left Sidebar: Component List (BaseName only) -->
        <aside class="sidebar" onscroll={handleListScroll}>
          <div class="sidebar-header">
            <div class="section-title">COMPONENTS ({family})</div>
            <lightning-input 
              type="search"
              variant="label-hidden"
              placeholder="Search..."
              value={search}
              onchange={onSearchChange}>
            </lightning-input>
          </div>
          
          <ul class="tree">
            <template for:each={uniqueComponents} for:item="comp">
              <li key={comp.baseName}
                  class="item"
                  data-basename={comp.baseName}
                  data-type={comp.type}
                  onclick={selectComponent}>
                <span class="file">üì¶</span>
                <div class="comp-info">
                  <strong>{comp.baseName}</strong>
                  <template if:true={comp.versionCount}>
                    <span class="ver-count">({comp.versionCount}v)</span>
                  </template>
                </div>
              </li>
            </template>
          </ul>
          
          <template if:true={listLoading}>
            <p class="muted loading-text">Loading...</p>
          </template>
        </aside>

        <!-- Right Panel: Version Cards OR History -->
        <main class="main" onscroll={handleMainScroll}>
          <!-- Show version cards when component selected -->
          <template if:true={hasSelectedComponent}>
            <template if:false={selectedVersion}>
              <div class="version-grid-container">
                <h2 class="main-title">{selectedComponentName}</h2>
                <div class="version-grid">
                  <template for:each={versionCards} for:item="vc">
                    <button key={vc.version}
                            class="version-card"
                            data-version={vc.version}
                            onclick={selectVersion}>
                      <span class="version-icon">üì¶</span>
                      <span class="version-label">{vc.label}</span>
                    </button>
                  </template>
                </div>
              </div>
            </template>
            
            <!-- Show history when version selected -->
            <template if:true={selectedVersion}>
              <!-- Tabs -->
              <div class="tabs">
                <button class={notesTabClass} data-tab="notes" onclick={switchTab}>Notes</button>
                <button class={diffTabClass} data-tab="diff" onclick={switchTab}>Diff</button>
                <button class={rawTabClass} data-tab="raw" onclick={switchTab}>Raw</button>
                <button class={timelineTabClass} data-tab="timeline" onclick={switchTab}>Timeline</button>
              </div>

              <!-- NOTES TAB -->
              <template if:true={showNotes}>
                <section class="tab-content">
                  <h1 class="title">{selectedComponentName} v{selectedVersion}</h1>
                  
                  <template for:each={historyItems} for:item="snap">
                    <article key={snap.id} class="history-card">
                      <div class="history-header">
                        <div class="history-badges">
                          <span class="badge change">{snap.changeType}</span>
                          <span class="badge version">v{snap.version}</span>
                          <template if:true={snap.actorName}>
                            <span class="badge actor">{snap.actorName}</span>
                          </template>
                        </div>
                        <span class="history-date">{snap.formattedDate}</span>
                      </div>
                      
                      <div class="markdown notes" data-id={snap.id}></div>
                      
                      <template if:true={snap.isExpanded}>
                        <div class="details-section">
                          <h4>Diff</h4>
                          <pre class="block">{snap.diffText}</pre>
                          
                          <h4>Raw JSON</h4>
                          <pre class="block">{snap.rawJson}</pre>
                        </div>
                      </template>
                      
                      <div class="history-actions">
                        <button class="text-btn" data-id={snap.id} onclick={toggleSnapshot}>
                          <template if:false={snap.isExpanded}>Show Details</template>
                          <template if:true={snap.isExpanded}>Hide Details</template>
                        </button>
                      </div>
                    </article>
                  </template>
                  
                  <template if:true={tlLoading}>
                    <p class="muted loading-text">Loading more...</p>
                  </template>
                </section>
              </template>

              <!-- DIFF TAB -->
              <template if:true={showDiff}>
                <section class="tab-content">
                  <h1 class="title">{selectedComponentName} v{selectedVersion} - Diff View</h1>
                  
                  <template for:each={historyItems} for:item="snap">
                    <article key={snap.id} class="history-card">
                      <div class="history-header">
                        <div class="history-badges">
                          <span class="badge change">{snap.changeType}</span>
                          <span class="badge version">v{snap.version}</span>
                        </div>
                        <span class="history-date">{snap.formattedDate}</span>
                      </div>
                      
                      <pre class="block diff-block">{snap.diffText}</pre>
                      
                      <div class="history-actions">
                        <button class="text-btn" data-id={snap.id} onclick={copyDiff}>Copy</button>
                      </div>
                    </article>
                  </template>
                </section>
              </template>

              <!-- RAW TAB -->
              <template if:true={showRaw}>
                <section class="tab-content">
                  <h1 class="title">{selectedComponentName} v{selectedVersion} - Raw JSON</h1>
                  
                  <template for:each={historyItems} for:item="snap">
                    <article key={snap.id} class="history-card">
                      <div class="history-header">
                        <div class="history-badges">
                          <span class="badge change">{snap.changeType}</span>
                          <span class="badge version">v{snap.version}</span>
                        </div>
                        <span class="history-date">{snap.formattedDate}</span>
                      </div>
                      
                      <pre class="block">{snap.rawJson}</pre>
                      
                      <div class="history-actions">
                        <button class="text-btn" data-id={snap.id} onclick={copyJson}>Copy</button>
                      </div>
                    </article>
                  </template>
                </section>
              </template>

              <!-- TIMELINE TAB -->
              <template if:true={showTimeline}>
                <section class="tab-content">
                  <h1 class="title">{selectedComponentName} v{selectedVersion} - Timeline</h1>
                  
                  <ul class="timeline">
                    <template for:each={historyItems} for:item="snap">
                      <li key={snap.id}>
                        <span class="tl-ver">v{snap.version}</span>
                        <span class="tl-when">{snap.formattedDate}</span>
                        <template if:true={snap.actorName}>
                          ‚Äî <span class="tl-actor">{snap.actorName}</span>
                        </template>
                        <span class="tl-change">({snap.changeType})</span>
                      </li>
                    </template>
                  </ul>
                </section>
              </template>
            </template>
          </template>

          <!-- Empty state -->
          <template if:false={hasSelectedComponent}>
            <div class="empty-state">
              <p class="muted">Select a component from the left to view its version history</p>
            </div>
          </template>
        </main>
      </div>
    </div>
  </template>
</template>